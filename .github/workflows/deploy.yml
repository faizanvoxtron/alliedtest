name: Deploy to Server

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Set up SSH
      uses: webfactory/ssh-agent@v0.6.0
      with:
        ssh-private-key: ${{ secrets.DEPLOY_SSH_KEY }}

    - name: Set git safe directory
      run: |
        ssh -o StrictHostKeyChecking=no root@38.75.137.11 << 'EOF'
          git config --global --add safe.directory /var/www/html/brands/alliedipfirm.com
        EOF

    - name: Deploy to server
      run: |
        ssh -o StrictHostKeyChecking=no root@38.75.137.11 << 'EOF'
          set -e

          # Save the current state (last successful commit)
          cd /var/www/html/brands/alliedipfirm.com
          LAST_COMMIT=$(git rev-parse HEAD)
          echo $LAST_COMMIT > /root/last_commit

          # Try to deploy
          git checkout main
          git pull origin main || { 
            echo "Deployment failed, rolling back..."; 
            git reset --hard $(cat /root/last_commit); 
            exit 1; 
          }

          # Change ownership after deployment
          chown -R www-data:www-data /var/www/html/brands/alliedipfirm.com
          # Uncomment if Apache needs to be restarted after deployment
          # sudo systemctl restart apache2
        EOF

    - name: Send email notification on success
      if: success()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.yandex.com
        server_port: 465
        username: deployment-alerts@voxtrongroup.com
        password: DevOps123$%67
        subject: "Deployment Successful"
        body: |
          The deployment to the server has been successfully completed.
          Site URL: "alliedipfirm.com"
          Repository: ${{ github.repository }}
          Branch: ${{ github.ref }}
        to: "devops@voxtrongroup.com , harsham@voxtrongroup.com"
        from: "deployment-alerts@voxtrongroup.com"

    - name: Send email notification on failure
      if: failure()
      uses: dawidd6/action-send-mail@v3
      with:
        server_address: smtp.yandex.com
        server_port: 465
        username: deployment-alerts@voxtrongroup.com
        password: DevOps123$%67
        subject: "Deployment Failed - Rollback Executed"
        body: |
          The deployment to the server has failed and a rollback has been executed.
          Please check the logs for more details.
          Site URL: "alliedipfirm.com"
          Repository: ${{ github.repository }}
          Branch: ${{ github.ref }}
        to: "devops@voxtrongroup.com"
        from: "deployment-alerts@voxtrongroup.com"
